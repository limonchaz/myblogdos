version: 2
jobs:
    build-job:
        docker:
            - image: cibuilds/hugo:latest
        working_directory: ~/project
        steps:
            - checkout
            - run:
                name: "Run Hugo"
                command: HUGO_ENV=production hugo -v -s ~/project/
        
    deploy-job:
        docker:
            - image: cibuilds/hugo:latest
        working_directory: ~/project
        steps:
            - checkout
            - run:
                name: "Run Hugo"
                command: HUGO_ENV=production hugo -v -s ~/project/
            - add_ssh_keys
            - run:
                name: Push to git
                command: |
                    git config --global user.email "citrix.ko@gmail.com"
                    git config --global user.name "CircleCI"
                    git add docs/
                    git commit -m "Release"
                    git push origin master
                    increment=0.1
                    tag=$(git tag | sed '$!d')
                    if [[ -z $tag ]] ; then
                       git tag -a v1.0 -m 'Version 1.0'
                    else
                       version=$(echo "$tag" | grep -o -E '[0-9.0-9]+')
                       num=$(echo $version + $increment | bc)
                       echo "Tag v$num"
                       git tag -a v$num -m 'Version $num'
                    fi
                    git push --tags

workflows:
    version: 2
    build-deploy:
        jobs:
            - build-job
            - deploy-job:
                requires:
                    - build-job
                filters:
                    branches:
                        only: master
